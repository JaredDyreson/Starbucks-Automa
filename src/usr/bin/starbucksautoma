#!/usr/bin/env python3.5

# official driver code, written by Jared Dyreson
# all rights reserved
# free to use and modify

from starbucksautoma import driver_utils as du
from starbucksautoma import json_parser as jp
from starbucksautoma import starbucks_week

from selenium import webdriver
from selenium.webdriver.firefox.options import Options

import time
import getpass

username_ = getpass.getuser()
portal_url = "https://sbux.co/teamworks"
headless_ = Options()
headless_.headless = True
driver = webdriver.Firefox(options=headless_)
p = jp.jsonparser("/home/{}/Applications/starbucks_automa/credentials/config.json".format(username_))

print("[+] Loading portal login page....")
driver.get(portal_url)
pd = du.portal_driver(driver, p)

print("[+] Finding and filling username field....")
pd.wait_for_element("span[class='sbuxheadertext']")
pd.fill_and_submit_username_field()

print("[+] Finding and filling in two factor authentication...")
pd.wait_for_element("span[class='bodytext lblKBQIndicator lblKBQIndicator1']")
pd.fill_and_submit_two_factor_auth()

print("[+] Finding and filling in password field...")
pd.wait_for_element("a[id='sbuxForgotPasswordURL']")
pd.fill_and_submit_password_field()
pd.wait_for_element("img[class='x-img rp-redprairie-logo x-img-default']")
print("[+] Scraping inner HTML page...")
a = pd.scrape_current_week()
print("[+] Merging current week and days working...")
b = pd.scrape_week_merge_to_dict(a)
week = starbucks_week.starbucks_week(b, pd.get_current_week())
week_of = pd.get_current_week()
scheduled_hours = week.get_hours_scheduled()
print("[+] Killing marionette driver...")
pd.kill_marionette()
print("[+] Process killed...")
print("[+] Adding all events for week of {}...".format(week_of))
print("[+] Scheduled hours: {}".format(scheduled_hours))
print("[+] Projected pay: ${}".format(week.get_projected_income()))
week.add_to_calendar()
print("[+] Exiting....")
